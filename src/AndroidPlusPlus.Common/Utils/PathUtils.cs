////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

using System;
using System.CodeDom;
using System.CodeDom.Compiler;
using System.Collections;
using System.Collections.Generic;
using System.Diagnostics;
using System.Text;
using System.Text.RegularExpressions;
using System.IO;
using System.Runtime.InteropServices;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

namespace AndroidPlusPlus.Common
{

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  public class PathUtils
  {

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public static string SantiseWindowsPath (string path)
    {
      // 
      // Sanitise a Windows path.
      // 

      string expandedPath;

      if (path.Contains ("~"))
      {
        expandedPath = GetLongPathName (path);
      }
      else
      {
        expandedPath = path;
      }

      StringBuilder workingBuffer = new StringBuilder (expandedPath);

      workingBuffer.Replace (@"\\", "/");

      workingBuffer.Replace (@"\", "/");

      return QuoteIfNeeded (EscapePath (workingBuffer.ToString ()));
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public static string ConvertPathWindowsToWsl (string path)
    {
      // 
      // Convert Windows path in to a WSL/MinGW path. I.e: C:\Windows\System32 -> /c/windows/system32
      // 

      string expandedPath;

      if (path.Contains ("~"))
      {
        expandedPath = GetLongPathName (path);
      }
      else
      {
        expandedPath = path;
      }

      StringBuilder workingBuffer = new StringBuilder (expandedPath);

      workingBuffer.Replace ('\\', '/');

      string driveRoot = Path.GetPathRoot (path);

      if (!string.IsNullOrEmpty (driveRoot))
      {
        workingBuffer.Replace (driveRoot, "/" + driveRoot.Substring (0, 1).ToLower () + "/");
      }

      return QuoteIfNeeded (workingBuffer.ToString ());
    }


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public static string ConvertPathWindowsToCygwin (string path)
    {
      // 
      // Convert Windows path in to a Cygwin-style path. I.e: C:\Windows\System32 -> /cygdrive/c/Windows/System32
      // 

      return "/cygdrive" + ConvertPathWindowsToWsl (path);
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public static string ConvertPathWslToWindows (string path)
    {
      // 
      // Convert a Mingw path in to a Windows path. I.e: /c/Windows/System32 -> C:\Windows\System32
      // 

      StringBuilder workingBuffer = new StringBuilder (path);

      if (workingBuffer [0] == '/' && workingBuffer [2] == '/')
      {
        workingBuffer.Replace (path.Substring (0, 3), char.ToUpper (workingBuffer [1]) + ":\\");
      }

      workingBuffer.Replace ('/', '\\');

      workingBuffer.Replace ("\\\\", "\\");

      return workingBuffer.ToString ();
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public static string ConvertPathCygwinToWindows (string path)
    {
      return ConvertPathWslToWindows (path.Replace("/cygdrive", ""));
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public static string QuoteIfNeeded (string arg)
    {
      // 
      // Add quotes around a string, if they are needed.
      // 

      if (arg.StartsWith ("\""))
      {
        return arg;
      }

      var match = arg.IndexOfAny (new char [] { ' ', '\t', ';', '&' }) != -1;

      if (!match)
      {
        return arg;
      }

      return "\"" + arg + "\"";
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public static string EscapePath (string input)
    {
      StringBuilder escapedStringBuilder = new StringBuilder (input);

      escapedStringBuilder.Replace (@"\", @"\\");

      escapedStringBuilder.Replace (@" ", @"\ ");

      return escapedStringBuilder.ToString ();
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public static string UnescapePath (string path)
    {
      StringBuilder unescapedStringBuilder = new StringBuilder (path);

      unescapedStringBuilder.Replace (@"\\", @"\");

      unescapedStringBuilder.Replace (@"\ ", @" ");

      return unescapedStringBuilder.ToString ();
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public static string NormalizePath (string path)
    {
      return Path.GetFullPath(new Uri(path).LocalPath).TrimEnd(Path.DirectorySeparatorChar, Path.AltDirectorySeparatorChar);
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public static string GetExactPathName(string path)
    {
      if (!(File.Exists(path) || Directory.Exists(path)))
      {
        return path;
      }

      var di = new DirectoryInfo(path);

      if (di.Parent != null)
      {
        return Path.Combine(GetExactPathName(di.Parent.FullName), di.Parent.GetFileSystemInfos(di.Name)[0].Name);
      }
      else
      {
        return di.Name.ToUpper();
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public static string GetShortPathName (string path)
    {
      StringBuilder shortPath = new StringBuilder (260);

      GetShortPathName (path, shortPath, shortPath.Capacity);

      return shortPath.ToString ();
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    [DllImport ("kernel32.dll", CharSet = CharSet.Unicode)]
    private static extern int GetShortPathName ([MarshalAs (UnmanagedType.LPWStr)] string path, [MarshalAs (UnmanagedType.LPWStr)] StringBuilder shortPath, int shortPathLength);

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public static string GetLongPathName (string path)
    {
      StringBuilder longPath = new StringBuilder (1024);

      GetLongPathName (path, longPath, longPath.Capacity);

      return longPath.ToString ();
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    [DllImport ("kernel32.dll", CharSet = CharSet.Unicode)]
    private static extern int GetLongPathName ([MarshalAs (UnmanagedType.LPWStr)] string path, [MarshalAs (UnmanagedType.LPWStr)] StringBuilder longPath, int longPathLength);

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  }


  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
