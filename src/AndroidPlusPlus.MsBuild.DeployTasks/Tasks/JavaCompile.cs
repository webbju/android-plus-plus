////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

using AndroidPlusPlus.Common;
using AndroidPlusPlus.MsBuild.Common;
using AndroidPlusPlus.MsBuild.Common.Attributes;
using Microsoft.Build.Framework;
using Microsoft.Build.Utilities;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Resources;
using System.Text;
using System.Threading;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

namespace AndroidPlusPlus.MsBuild.DeployTasks.Tasks
{

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  public class JavaCompile : TrackedOutOfDateToolTask
  {

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private HashSet<string> _outputClassPackages = new HashSet<string>();

    private List<ITaskItem> _outputClassSourceFiles = new List<ITaskItem>();

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public JavaCompile()
      : base(new ResourceManager("AndroidPlusPlus.MsBuild.DeployTasks.Properties.Resources", Assembly.GetExecutingAssembly()))
    {
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    [SwitchBool(Switch = "-g", ReverseSwitch = "-g:none")]
    public bool GenerateDebuggingInfo { get; set; }

    [SwitchBool(Switch = "-nowarn")]
    public bool NoWarnings { get; set; }

    [SwitchBool(Switch = "-verbose")]
    public bool Verbose { get; set; }

    [SwitchBool(Switch = "-deprecation")]
    public bool Deprecation { get; set; }

    [SwitchStringList(Subtype = "folder", Switch = "-classpath", Separator = " ", CommandLineValueSeparator = ";")]
    public ITaskItem[] ClassPaths { get; set; }

    [SwitchStringList(Subtype = "folder", Switch = "-sourcepath", Separator = " ", CommandLineValueSeparator = ";")]
    public ITaskItem[] SourcePaths { get; set; }

    [SwitchStringList(Subtype = "folder", Switch = "-bootclasspath", Separator = " ", CommandLineValueSeparator = ";")]
    public ITaskItem[] BootClassPaths { get; set; }

    [SwitchStringList(Subtype = "folder", Switch = "-Djava.ext.dirs", Separator = "=", CommandLineValueSeparator = ";")]
    public ITaskItem[] ExtDirs { get; set; }

    [SwitchStringList(Subtype = "folder", Switch = "-Djava.endorsed.dirs", Separator = "=", CommandLineValueSeparator = ";")]
    public ITaskItem[] EndorsedDirs { get; set; }

    [SwitchStringList(Switch = "-processor", Separator = " ", CommandLineValueSeparator = ",")]
    public string[] AnnotationProcessors { get; set; }

    [SwitchStringList(Subtype = "folder", Switch = "-processorpath", Separator = " ")]
    public ITaskItem[] AnnotationProcessorPaths { get; set; }

    [SwitchString(Subtype = "folder", Switch = "-d", Separator = " ")]
    public ITaskItem GeneratedClassFileOutputPath { get; set; }

    [SwitchString(Subtype = "folder", Switch = "-s", Separator = " ")]
    public ITaskItem GeneratedSourceFileOutputPath { get; set; }

    [SwitchString(Subtype = "folder", Switch = "-h", Separator = " ")]
    public ITaskItem GeneratedNativeHeaderOutputPath { get; set; }

    [SwitchEnum(Switch = "-encoding", Separator = " ")]
    [SwitchEnumValue(Name = "UTF-8", Switch = "UTF-8")]
    public string Encoding { get; set; }

    [SwitchEnum(Switch = "-source", Separator = " ")]
    [SwitchEnumValue(Name = "1.3", Switch = "1.3")]
    [SwitchEnumValue(Name = "1.4", Switch = "1.4")]
    [SwitchEnumValue(Name = "1.5", Switch = "1.5")]
    [SwitchEnumValue(Name = "1.6", Switch = "1.6")]
    [SwitchEnumValue(Name = "1.7", Switch = "1.7")]
    [SwitchEnumValue(Name = "1.8", Switch = "1.8")]
    [SwitchEnumValue(Name = "5", Switch = "5")]
    [SwitchEnumValue(Name = "6", Switch = "6")]
    [SwitchEnumValue(Name = "7", Switch = "7")]
    [SwitchEnumValue(Name = "8", Switch = "8")]
    [SwitchEnumValue(Name = "9", Switch = "9")]
    public string SourceVersion { get; set; }

    [SwitchEnum(Switch = "-target", Separator = " ")]
    [SwitchEnumValue(Name = "1.3", Switch = "1.3")]
    [SwitchEnumValue(Name = "1.4", Switch = "1.4")]
    [SwitchEnumValue(Name = "1.5", Switch = "1.5")]
    [SwitchEnumValue(Name = "1.6", Switch = "1.6")]
    [SwitchEnumValue(Name = "1.7", Switch = "1.7")]
    [SwitchEnumValue(Name = "1.8", Switch = " 1.8")]
    [SwitchEnumValue(Name = "5", Switch = "5")]
    [SwitchEnumValue(Name = "6", Switch = "6")]
    [SwitchEnumValue(Name = "7", Switch = "7")]
    [SwitchEnumValue(Name = "8", Switch = "8")]
    [SwitchEnumValue(Name = "9", Switch = "9")]
    public string TargetVersion { get; set; }

    [SwitchBool(Switch = "-Werror")]
    public bool WarningsAsErrors { get; set; }

    [Required]
    [SwitchStringList(Subtype = "file", IsRequired = true)]
    public ITaskItem[] SourceFiles { get; set; }

    [Output]
    public ITaskItem[] OutputClassFiles => _outputClassSourceFiles.ToArray();

    [Output]
    public ITaskItem[] OutputClassPaths => _outputClassPackages.Select(str => new TaskItem(str)).ToArray<ITaskItem>();

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    protected override bool ValidateParameters()
    {
      InputFiles = SourceFiles;

      return base.ValidateParameters();
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    protected override void LogEventsFromTextOutput(string singleLine, MessageImportance messageImportance)
    {
      base.LogEventsFromTextOutput(JavaUtilities.ConvertJavaOutputToVS(singleLine), messageImportance);

      //
      // Intercept output class filenames and package addresses
      // .
      // e.g.
      //  [checking com.example.nativemedia.MyRenderer]
      //  [wrote AndroidMT\Debug\bin\classes\com\example\nativemedia\MyRenderer.class]
      //

      if (singleLine?.StartsWith("[") ?? false)
      {
        string sanitisedOutput = singleLine.Trim(new char[] { ' ', '[', ']' });

        if (sanitisedOutput.StartsWith("checking "))
        {
          string packageNameWithClassName = sanitisedOutput.Substring("checking ".Length);

          string packageNameWithoutClass = packageNameWithClassName.Substring(0, packageNameWithClassName.LastIndexOf('.'));

          _outputClassPackages.Add(packageNameWithoutClass);
        }
        else if (sanitisedOutput.StartsWith("wrote "))
        {
          string fileWritten = sanitisedOutput.Substring("wrote ".Length);

          fileWritten = StripFileObjectDescriptor(fileWritten);

          _outputClassSourceFiles.Add(new TaskItem(fileWritten));
        }
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private static string StripFileObjectDescriptor(string fileObjectDescription)
    {
      //
      // Convert from JDK 7-style verbose file output to the raw filename.
      //
      // e.g: [wrote RegularFileObject[..\..\build\obj\android\vs10.0\NMG_System\debug_no_assets\bin\classes\com\google\android\gms\R$attr.class]]
      //

      int filenameStart = fileObjectDescription.LastIndexOf('[');

      if (filenameStart != -1)
      {
        fileObjectDescription = fileObjectDescription.Substring(filenameStart).Trim(new char[] { '[', ']' });
      }

      return fileObjectDescription;
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  }

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
